<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Kallan Gerard"><meta name=description content="When I started using Traefik v2, I struggled to find a useful guide to use it with Home Assistant. Here&amp;rsquo;s my attempt to fill that gap."><meta name=keywords content="homepage,blog,Home Assistant,Traefik,Traefik v2,Docker,Docker Compose,Home Automation"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://kallangerard.github.io/posts/2020/10/how-to-use-traefik-v2-with-home-assistant/><title>How to Use Traefik v2 With Home Assistant :: Kallan Gerard</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.ab90eb5ef7e80d4e84606ea8b62d18bf3a45232aaad09fb1666a2f96223408ea.css><meta itemprop=name content="How to Use Traefik v2 With Home Assistant"><meta itemprop=description content="When I started using Traefik v2, I struggled to find a useful guide to use it with Home Assistant. Here&rsquo;s my attempt to fill that gap."><meta itemprop=datePublished content="2020-10-13T13:10:41+08:00"><meta itemprop=dateModified content="2020-10-13T13:10:41+08:00"><meta itemprop=wordCount content="1509"><meta itemprop=image content="https://kallangerard.github.io/"><meta itemprop=keywords content="Home Assistant,Traefik,Traefik v2,Docker,Docker Compose,Home Automation,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kallangerard.github.io/"><meta name=twitter:title content="How to Use Traefik v2 With Home Assistant"><meta name=twitter:description content="When I started using Traefik v2, I struggled to find a useful guide to use it with Home Assistant. Here&rsquo;s my attempt to fill that gap."><meta property="og:title" content="How to Use Traefik v2 With Home Assistant"><meta property="og:description" content="When I started using Traefik v2, I struggled to find a useful guide to use it with Home Assistant. Here&rsquo;s my attempt to fill that gap."><meta property="og:type" content="article"><meta property="og:url" content="https://kallangerard.github.io/posts/2020/10/how-to-use-traefik-v2-with-home-assistant/"><meta property="og:image" content="https://kallangerard.github.io/"><meta property="article:published_time" content="2020-10-13T13:10:41+08:00"><meta property="article:modified_time" content="2020-10-13T13:10:41+08:00"><meta property="article:published_time" content="2020-10-13 13:10:41 +0800 +0800"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Kallan Gerard</span>
<span class=logo__cursor style=visibility:hidden></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://kallangerard.github.io/posts/>Posts</a></li><li><a href=https://kallangerard.github.io/reading-list/>Reading List</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>8 minutes</p></div><article><h1 class=post-title><a href=https://kallangerard.github.io/posts/2020/10/how-to-use-traefik-v2-with-home-assistant/>How to Use Traefik v2 With Home Assistant</a></h1><div class=post-content><p>When I started using Traefik v2, I struggled to find a useful guide to use it with Home Assistant. Here&rsquo;s my attempt to fill that gap.</p><p>To attempt this you&rsquo;ll want a working understanding of how reverse proxies are used, as well as experience with Docker. You&rsquo;ll also require a domain name.</p><p>The main benefits of Traefik for me have been:</p><ul><li><strong>Service Discovery:</strong> Traefik can use metadata from your Docker services to discover those services and dynamically configure itself.</li><li><strong>SSL Termination and Automatic certificate generation:</strong> Using Let&rsquo;s Encrypt you can get self-renewing certificates out of the box, including for use inside your own network.</li><li><strong>Middleware:</strong> Hand off authentication to another service, set headers, redirect HTTP to HTTPS etc.</li></ul><p><em>Here&rsquo;s a complete working example for those of you who are almost there but just want a quick reference guide. Please note I&rsquo;m using Home Assistant inside a docker network and not on host_mode. For device discovery in this mode I recommend using a second remote home assistant instance which I&rsquo;ll cover in another article.</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># docker-compose.yaml</span>
---
<span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;2.3&#34;</span>

<span style=color:#f92672>services</span>:

  <span style=color:#f92672>traefik</span>:
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:v2.2.1</span>
      <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>traefik</span>
      <span style=color:#f92672>ports</span>:
        - <span style=color:#ae81ff>80</span>:<span style=color:#ae81ff>80</span>
        - <span style=color:#ae81ff>443</span>:<span style=color:#ae81ff>443</span>
      <span style=color:#f92672>networks</span>:
        - <span style=color:#ae81ff>default</span>
        - <span style=color:#ae81ff>backend</span>
      <span style=color:#f92672>environment</span>:
        - <span style=color:#ae81ff>CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}</span>
      <span style=color:#f92672>volumes</span>:
        - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock:ro</span>
        - <span style=color:#ae81ff>traefik:/letsencrypt</span>
      <span style=color:#f92672>command</span>:
	      - --<span style=color:#ae81ff>entrypoints.web.address=:80</span>
        - --<span style=color:#ae81ff>entrypoints.websecure.address=:443</span>
        - --<span style=color:#ae81ff>providers.docker</span>
        - --<span style=color:#ae81ff>providers.docker.exposedbydefault=false</span>
        - --<span style=color:#ae81ff>providers.docker.endpoint=unix://var/run/docker.sock</span>
        <span style=color:#75715e># network name is &lt;projectname&gt;_backend</span>
        - --<span style=color:#ae81ff>providers.docker.network=docker_backend</span>
        <span style=color:#75715e># certificatesresolver.&lt;any_name&gt;.acme</span>
        - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare</span>
        - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json</span>
        - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53</span>
      <span style=color:#f92672>labels</span>:
        - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
        <span style=color:#75715e># global redirect to https</span>
        - <span style=color:#e6db74>&#34;traefik.http.routers.redirs.entrypoints=web&#34;</span>
        - <span style=color:#e6db74>&#34;traefik.http.routers.redirs.rule=hostregexp(`{host:.+}`)&#34;</span>
        <span style=color:#75715e># HTTP&gt;HTTPS REDIRECT</span>
        - <span style=color:#e6db74>&#34;traefik.http.routers.redirs.middlewares=redirect-to-https&#34;</span>
        - <span style=color:#e6db74>&#34;traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https&#34;</span>
      <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>

  <span style=color:#f92672>homeassistant</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>homeassistant/home-assistant:0.113.2</span>
    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>homeassistant</span>
    <span style=color:#f92672>networks</span>:
      - <span style=color:#ae81ff>backend</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>PGID=${DOCKER_PGID}</span>
      - <span style=color:#ae81ff>PUID=${DOCKER_PUID}</span>
      - <span style=color:#ae81ff>TZ=${TIME_ZONE}</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>homeassistant:/config</span>
      - <span style=color:#ae81ff>/etc/localtime:/etc/localtime:ro</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.entrypoints=websecure&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.rule=Host(`homeassistant.${DOMAIN_NAME}`)&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.tls=true&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.tls.certresolver=cloudflare&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.services.homeassistant.loadbalancer.server.port=8123&#34;</span>
    <span style=color:#f92672>healthcheck</span>:
      <span style=color:#f92672>test</span>: [<span style=color:#e6db74>&#34;CMD&#34;</span>, <span style=color:#e6db74>&#34;curl&#34;</span>, <span style=color:#e6db74>&#34;-f&#34;</span>, <span style=color:#e6db74>&#34;http://localhost:8123&#34;</span>]
      <span style=color:#f92672>interval</span>: <span style=color:#ae81ff>2m</span>
      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>10s</span>
      <span style=color:#f92672>retries</span>: <span style=color:#ae81ff>3</span>
      <span style=color:#f92672>start_period</span>: <span style=color:#ae81ff>40s</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>

<span style=color:#f92672>networks</span>:
  <span style=color:#f92672>default</span>:
  <span style=color:#f92672>backend</span>:

<span style=color:#f92672>volumes</span>:
  <span style=color:#f92672>traefik</span>:
  <span style=color:#f92672>homeassistant</span>:
</code></pre></div><h2 id=defining-traefik-in-docker-compose>Defining Traefik in Docker Compose</h2><p>Let&rsquo;s start from the top.</p><p>You will need at least two networks. Here I&rsquo;m using the default, and another for the backend services.</p><p><em>Make sure to use a specific image version. Your Application Proxy is not something you want pulling latest</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>traefik</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:v2.2.1</span>
		<span style=color:#ae81ff>...</span>
    <span style=color:#f92672>networks</span>:
      - <span style=color:#ae81ff>default</span>
      - <span style=color:#ae81ff>backend</span>
</code></pre></div><p>Traefik will require read only access to your docker socket. This allows Traefik to read the metadata of your containers for service discovery. We also use a volume for traefik to store certificates.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>volumes</span>:
  - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock:ro</span>
  - <span style=color:#ae81ff>traefik:/letsencrypt</span>
</code></pre></div><p>I use a custom docker run command to configure Traefik. I prefer this over using configuration files as it keeps it all within one place. In addition, when you make a change Docker Compose will restart Traefik for you.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>command</span>:
  - --<span style=color:#ae81ff>entrypoints.web.address=:80</span>
  - --<span style=color:#ae81ff>entrypoints.websecure.address=:443</span>
  - --<span style=color:#ae81ff>providers.docker</span>
  - --<span style=color:#ae81ff>providers.docker.exposedbydefault=false</span>
  - --<span style=color:#ae81ff>providers.docker.endpoint=unix://var/run/docker.sock</span>
  <span style=color:#75715e># network name is &lt;projectname&gt;_backend</span>
  - --<span style=color:#ae81ff>providers.docker.network=docker_backend</span>
  - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare</span>
  - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json</span>
  - --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53</span>
</code></pre></div><p>There&rsquo;s a few ways to configure Traefik, you can use whichever method you prefer, they are all equivalent.</p><p><em>Pluralisation and capitalisation are different for each configuration mode.</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># docker-compose.yaml</span>
<span style=color:#f92672>command</span>:
  - --<span style=color:#ae81ff>entrypoints.web.address=:80</span>
  - --<span style=color:#ae81ff>entrypoints.websecure.address=:443</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># traefik.yaml</span>
<span style=color:#f92672>entryPoints</span>:
  <span style=color:#f92672>web</span>:
    <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#39;:80&#39;</span>
  <span style=color:#f92672>websecure</span>:
    <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#39;:443&#39;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#75715e># traefik.toml</span>
[<span style=color:#a6e22e>entryPoints</span>.<span style=color:#a6e22e>web</span>]
<span style=color:#a6e22e>address</span> = <span style=color:#e6db74>&#34;:80&#34;</span>
[<span style=color:#a6e22e>entryPoints</span>.<span style=color:#a6e22e>websecure</span>]
<span style=color:#a6e22e>address</span> = <span style=color:#e6db74>&#34;:443&#34;</span>
</code></pre></div><h2 id=entrypoints>Entrypoints</h2><p>Entrypoints define the outside edge of your Traefik service. For standard HTTP you&rsquo;ll need port 80 and for HTTPS you&rsquo;ll need 443.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- --<span style=color:#ae81ff>entrypoints.web.address=:80</span>
- --<span style=color:#ae81ff>entrypoints.websecure.address=:443</span>
</code></pre></div><h2 id=providers>Providers</h2><p>Providers define where Traefik will look for services.</p><p>We need one flag to declare docker being used as a provider.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- --<span style=color:#ae81ff>providers.docker</span>
</code></pre></div><p>To make sure Traefik doesn&rsquo;t try to expose every Docker service by default, we declare</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- --<span style=color:#ae81ff>providers.docker.exposedbydefault=false</span>
</code></pre></div><p>We also set the network to match what is used by your service containers, to avoid having to set it for every individual container.</p><p>The name of the network is the <strong>absolute</strong> network name, which by default is the name of the folder where your docker-compose.yaml file lives and the name of the network. To confirm your network names run <code>docker network ls</code>. In my case it&rsquo;s <code>docker_backend</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- --<span style=color:#ae81ff>providers.docker.network=docker_backend</span>
</code></pre></div><h2 id=certificate-resolvers>Certificate Resolvers</h2><p>Certificate Resolvers are used for the automatic generation of your certificates for HTTPS. Check traefik&rsquo;s documentation for your exact configuration requirements. <a href=https://doc.traefik.io/traefik/https/acme/>https://doc.traefik.io/traefik/https/acme/</a></p><p><em>Since there is no inline assignment, Docker Compose will pull the environment variables
from the environment where you run <code>docker-compose up</code></em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>
<span style=color:#f92672>environment</span>:
  - <span style=color:#ae81ff>CLOUDFLARE_DNS_API_TOKEN</span>
<span style=color:#f92672>command</span>:
	<span style=color:#75715e># ...</span>
	- --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare</span>
	- --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json</span>
	- --<span style=color:#ae81ff>certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53</span>
</code></pre></div><p>I&rsquo;m using a dns challenge process to allow Let&rsquo;s Encrypt to prove I control my domain.</p><p>When a service is defined with a host name, Traefik will kick off the certificate generation process.</p><p>Traefik will call Let’s Encrypt and receive a token, and then create a TXT record derived from that token and your account key with your dns provider at _acme-challenge.&lt;YOUR_DOMAIN>. Traefik will then check the DNS record for your domain until the token resolves. Afterwards Let’s Encrypt will validate the DNS on it&rsquo;s end and hand over a certificate to Traefik.</p><p>I&rsquo;m manually specifying the DNS servers to check the TXT record with <code>certificatesresolvers.cloudflare.acme.dnschallenge.resolvers</code> because my internal DNS would interfer with this check.</p><p>Traefik will then take that certificate and store it permanently in the location defined in <code>certificatesresolvers.cloudflare.acme.storage</code>.</p><p>The main advantage here is, unlike a HTTP challenge, your Traefik instance does not need to be reachable from the internet at all. As long as it can make an outgoing connection to your DNS provider and Let&rsquo;s Encrypt you&rsquo;re good to keep your services behind a VPN and firewall at all times.</p><h2 id=redirecting-http-to-https-optional>Redirecting HTTP to HTTPS (optional)</h2><p>Traefik is comprised of entrypoints, routers, middleware and services.
We create a http router rule, arbitrarily named <code>redirs</code>, to listen on the web entrypoint (port 80), with a regex expression that applies to <em>all</em> host names. So effectively every HTTP client request that hits Traefik on port 80 will be handled by this router.</p><p><em>Backticks ` are required to define a host rule, not single quotes &lsquo;</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>labels</span>:
  - <span style=color:#e6db74>&#39;traefik.enable=true&#39;</span>
  <span style=color:#75715e># global redirect to https</span>
  - <span style=color:#e6db74>&#39;traefik.http.routers.redirs.entrypoints=web&#39;</span>
  - <span style=color:#e6db74>&#39;traefik.http.routers.redirs.rule=hostregexp(`{host:.+}`)&#39;</span>
</code></pre></div><p>Then we define a piece of middleware, arbitrarily named <code>redirect-to-https</code>, to redirect incoming request to https.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># HTTP&gt;HTTPS REDIRECT</span>
- <span style=color:#e6db74>&#39;traefik.http.routers.redirs.middlewares=redirect-to-https&#39;</span>
- <span style=color:#e6db74>&#39;traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https&#39;</span>
</code></pre></div><h2 id=defining-home-assistant-rules>Defining Home Assistant Rules</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>homeassistant</span>:
    <span style=color:#ae81ff>...</span>
    <span style=color:#f92672>networks</span>:
      - <span style=color:#ae81ff>backend</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.entrypoints=websecure&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.rule=Host(`homeassistant.${DOMAIN_NAME}`)&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.tls=true&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.routers.homeassistant.tls.certresolver=cloudflare&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.services.homeassistant.loadbalancer.server.port=8123&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.services.homeassistant.loadbalancer.sticky=true&#34;</span>
      - <span style=color:#e6db74>&#34;traefik.http.services.homeassistant.loadbalancer.sticky.cookie.name=homeassistant&#34;</span>
</code></pre></div><p>You&rsquo;ll need to set up your Home Assistant definition in Docker Compose to your particular circumstances, which is outside the scope of this article. But to enable Traefik we need to provide at least the following rules.</p><p>The container needs to use the backend network</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>networks</span>:
  - <span style=color:#ae81ff>backend</span>
</code></pre></div><p>We tell Traefik to use this container</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#e6db74>&#39;traefik.enable=true&#39;</span>
</code></pre></div><p>Allow HTTP access to Home Assistant on the websecure endpoint (port 443), and define a rule to match. In this case I&rsquo;m using a subdomain of homeassistant with a domain name I own.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#e6db74>&#39;traefik.http.routers.homeassistant.entrypoints=websecure&#39;</span>
- <span style=color:#e6db74>&#39;traefik.http.routers.homeassistant.rule=Host(`homeassistant.${DOMAIN_NAME}`)&#39;</span>
</code></pre></div><p>Request a certificate for HTTPS from Let&rsquo;s Encrypt, using the certsresolver <code>cloudflare</code> we defined earlier.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#e6db74>&#39;traefik.http.routers.homeassistant.tls=true&#39;</span>
- <span style=color:#e6db74>&#39;traefik.http.routers.homeassistant.tls.certresolver=cloudflare&#39;</span>
</code></pre></div><p>If a container is authored properly, Traefik will be able to get this information from the docker container itself without you having to define it manually. But unfortunately that&rsquo;s not the case here, so we have to define the port inside the container for Traefik to forward to.</p><p><em>Every service in Traefik has a load balancer, even if there is only one upstream service</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#e6db74>&#39;traefik.http.services.homeassistant.loadbalancer.server.port=8123&#39;</span>
</code></pre></div><p>Finally we just need to define the networks used by Traefik. As noted earlier, when defining the network name in traefik labels or configuration, you must use the absolute network name, which by default is <code>&lt;docker_compose_project_name>_&lt;network_name></code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>networks</span>:
  <span style=color:#f92672>default</span>:
  <span style=color:#f92672>backend</span>:
</code></pre></div><h2 id=dns>DNS</h2><p>Now the final catch is making sure you and your clients can reach your Traefik instance. Depending on your network configuration you&rsquo;ll have to do one of the following:</p><h3 id=internal-access-only>Internal Access Only</h3><p>You will need to use an internally managed DNS. I use my router to create a dnsmasq entry for my domain name, with the IP address of the server hosting Traefik. Be sure to include your subdomains or use a subdomain wildcard.</p><h3 id=external-web-access>External Web Access</h3><p>You&rsquo;ll need to forward port 80 and 443 to your Traefik server. And you&rsquo;ll probably need to enable a internal NAT reflection so your internal clients will be redirected appropriately.</p><p>You will also need to make sure your dns record with your DNS provider resolves to your WAN ip address.</p><p><em>These are both highly dependent on your network configuration. I wouldn&rsquo;t attempt these until you have a reasonable understanding of what you&rsquo;re doing</em></p><h2 id=bringing-it-up>Bringing it up</h2><p>Now we&rsquo;re finally ready to bring up your services. <code>docker-compose up -d</code> should bring up your Traefik and Home Assistant services up, and Traefik will read it&rsquo;s own and Home Assistant&rsquo;s labels. And now you can reach your Home Assistant instance with <code>https://homeassistant.domain.tld</code>.</p><h2 id=problems>Problems</h2><p>There&rsquo;s a lot of moving parts here, so don&rsquo;t stress if you have problems getting it to work at first. If you&rsquo;re not comfortable at debugging Docker services you might need to take a step back and bring up your skills there. Also make sure to read the documentation for Docker Compose, Docker and Traefik.</p><p>If you have any questions just leave a comment and I&rsquo;m happy to help.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://kallangerard.github.io/tags/home-assistant/>Home Assistant</a></span>
<span class=tag><a href=https://kallangerard.github.io/tags/traefik/>Traefik</a></span>
<span class=tag><a href=https://kallangerard.github.io/tags/traefik-v2/>Traefik v2</a></span>
<span class=tag><a href=https://kallangerard.github.io/tags/docker/>Docker</a></span>
<span class=tag><a href=https://kallangerard.github.io/tags/docker-compose/>Docker Compose</a></span>
<span class=tag><a href=https://kallangerard.github.io/tags/home-automation/>Home Automation</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1509 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-10-13 05:10</p></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"kallangerard"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://kallangerard.github.io/>Kallan Gerard</a></span>
<span>Kallan Gerard</span>
<span><a href=https://kallangerard.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-176245800-1','auto');ga('send','pageview');}</script></body></html>